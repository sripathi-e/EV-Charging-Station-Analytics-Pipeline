-- Create Hive Database
CREATE DATABASE IF NOT EXISTS ev_project;

-- Raw Table
CREATE EXTERNAL TABLE IF NOT EXISTS ev_project.ev_charging_sessions_raw (
    session_id INT,
    station_id STRING,
    city STRING,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    kWh_consumed DOUBLE,
    cost DOUBLE,
    charger_type STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LOCATION '/ev_project/raw/ev_charging_sessions';



-- Ensure Hive uses the correct database
USE ev_project;

-- 1️⃣ Daily City Summary
INSERT OVERWRITE TABLE ev_city_daily_summary
SELECT
city,
DATE(start_time) AS session_date,
COUNT(session_id) AS total_sessions,
SUM(kWh_consumed) AS total_kwh,
SUM(cost) AS total_revenue,
ROUND(AVG(kWh_consumed),2) AS avg_kwh_per_session
FROM ev_charging_sessions_raw
GROUP BY city, DATE(start_time);

-- 2️⃣ Charger Utilization by Hour
INSERT OVERWRITE TABLE ev_charger_utilization
SELECT
charger_type,
HOUR(start_time) AS hour_of_day,
COUNT(session_id) AS session_count,
SUM(kWh_consumed) AS total_kwh
FROM ev_charging_sessions_raw
GROUP BY charger_type, HOUR(start_time);
